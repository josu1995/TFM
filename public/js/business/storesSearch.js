"use strict";var mapa,myMarker,autocompleteInput,cercanaLat,cercanaLon,cercanaNombre,selectedLocalidad,visiblePuntos,mobile,storesList,geocoder,imagenMarker="/img/maps/transporter-marker-grey.png",markerActivo="/img/maps/transporter-marker-active.png",markerEnvio="/img/maps/transporter-marker-origen.png",markerRecogida="/img/maps/transporter-marker-destino.png",markers=[],visibleMarkers=[],scrolling=!1,error='<div class="alert alert-danger mg-15"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">×</a><p>No existen localidades para el texto introducido. Por favor, introduce una ciudad o código postal válido.</p></div>',scrollStartPos=0,scrollStartPosY=0;function initTouchHandler(){(storesList=$(".stores-list")).on("touchstart",(function(o){scrollStartPos=o.originalEvent.touches[0].clientX,scrollStartPosY=o.originalEvent.touches[0].clientY})),storesList.on("touchmove",(function(o){o.preventDefault(),o.stopImmediatePropagation(),o.originalEvent.touches[0].clientX,$(this)[0].scrollLeft=scrollStartPos-o.originalEvent.touches[0].clientX+storesList.scrollLeft(),$(".modal-body")[0].scrollTop=scrollStartPosY-o.originalEvent.touches[0].clientY+$(".modal-body").scrollTop(),scrollStartPos=o.originalEvent.touches[0].clientX,scrollStartPosY=o.originalEvent.touches[0].clientY})),storesList.on("touchend",(function(o){elementInViewport()}))}function initListeners(){$(".linkCercana").on("click",(function(){buscarLocalidad(cercanaNombre,cercanaLat,cercanaLon)})),$(".btn-location").click((function(){getLocation()})),$(".btn-buscar").click((function(){searchUserLocation()})),$("#autocomplete").keyup((function(o){var t=o.which;13===t&&o.preventDefault(),13!==t&&188!==t&&186!==t||searchUserLocation()}))}function updateDistances(o){var t=$(".punto-list-item").parent(),e=[];$(".punto-list-item").each((function(t){$(this).attr("data-distance",getDistance(o.lat(),o.lng(),$(this).attr("data-lat"),$(this).attr("data-lng"))),e.push({item:$(this)[0],punto:visiblePuntos[t]})}));var a=t.children();e.sort((function(o,t){var e=o.item.getAttribute("data-distance"),a=t.item.getAttribute("data-distance");return e>a?1:e<a?-1:0}));var r=[];e.forEach((function(o,t){a[t]=o.item,visiblePuntos[t]=o.punto,r.push(findMarker(o.punto))})),markers=r,a.detach().appendTo(t)}function getDistance(o,t,e,a){var r=deg2rad(e-o),i=deg2rad(a-t),n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(deg2rad(o))*Math.cos(deg2rad(e))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))}function deg2rad(o){return o*(Math.PI/180)}function searchUserLocation(){geocoder.geocode({address:$("#autocomplete").val()+", "+$(".ciudad-input").val().split("-")[0].trim()+", "+$(".ciudad-input").val().split("-")[1].trim()+", ES",componentRestrictions:{country:"ES"}},(function(o,t){t==google.maps.GeocoderStatus.OK&&"postal_code"!==o[0].types[0]&&"locality"!==o[0].types[0]&&"establishment"!==o[0].types[0]?(!myMarker||myMarker.position.lat()===o[0].geometry.location.lat()&&myMarker.position.lng()===o[0].geometry.location.lng()||myMarker.setMap(null),myMarker&&(!myMarker||myMarker.position.lat()===o[0].geometry.location.lat()&&myMarker.position.lng()===o[0].geometry.location.lng())||(myMarker=new google.maps.Marker({map:mapa,position:o[0].geometry.location,icon:"/img/maps/transporter-business-marker.png"}),mapa.panTo(myMarker.position),mapa.setZoom(12),updateDistances(o[0].geometry.location))):(myMarker&&(myMarker.setMap(null),myMarker=null),$(".search-input").popover("show"),$(".error-popover .popover-content strong").text($(".ciudad-input").val()),$("#modal-stores-search").one("click keyup",(function(){$(".error-popover").length&&$(".search-input").popover("hide")})))}))}function searchUserLocationByLatLng(o){geocoder.geocode({location:o},(function(o,t){t==google.maps.GeocoderStatus.OK&&"postal_code"!==o[0].types[0]?(!myMarker||myMarker.position.lat()===o[0].geometry.location.lat()&&myMarker.position.lng()===o[0].geometry.location.lng()||myMarker.setMap(null),myMarker&&(!myMarker||myMarker.position.lat()===o[0].geometry.location.lat()&&myMarker.position.lng()===o[0].geometry.location.lng())||(myMarker=new google.maps.Marker({map:mapa,position:o[0].geometry.location,icon:"/img/maps/transporter-business-marker.png"}),mapa.panTo(myMarker.position),mapa.setZoom(12),updateDistances(o[0].geometry.location))):(myMarker&&(myMarker.setMap(null),myMarker=null),$(".search-input").popover("show"),$(".error-popover .popover-content strong").text($(".ciudad-input").val()),$("#modal-stores-search").one("click keyup",(function(){$(".error-popover").length&&$(".search-input").popover("hide")})))}))}function elementInViewport(){for(var o=storesList.scrollLeft(),t=storesList.width(),e=storesList.children(),a=e.first().width(),r=0,i=null,n=0;n<e.length;n++){var s=100*(a-(o-n*a))/a;if(s>100)s=100*(a-(a*(n+1)-(o+t)))/a;s<0?s=0:s>100&&(s=100),s>r&&(r=s,i=e.eq(n))}hoverStore(i)}function getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((function(o){searchUserLocationByLatLng({lat:o.coords.latitude,lng:o.coords.longitude})})):alert("Este navegador no soporta la geolocalización.")}function mapsCallback(){crearMapa()}function crearMapa(){$(".close-mobile-btn").click((function(){$("#modal-stores-search").modal("hide")}));var o=$(".ciudad-input").val();(geocoder=new google.maps.Geocoder).geocode({address:o},(function(t,e){e==google.maps.GeocoderStatus.OK?processGeocoderResult(t,o):e==google.maps.GeocoderStatus.ZERO_RESULTS&&geocoder.geocode({address:o.split("-")[1].trim()},(function(t,e){e==google.maps.GeocoderStatus.OK&&processGeocoderResult(t,o)}))}))}function processGeocoderResult(o,t){myMarker=null,initListeners();var e={center:{lat:o[0].geometry.location.lat(),lng:o[0].geometry.location.lng()},zoom:5,disableDefaultUI:!0,zoomControl:!0,gestureHandling:"cooperative"};mapa=new google.maps.Map(document.getElementById("map"),e),buscarLocalidad(t,"","")}$((function(){(mobile=screen.width<768)?($("body").off("touchstart"),$("body").on("touchstart ",(function(o){$(".popover").length?$('a[aria-describedby^="popover"]').popover("toggle"):$(o.target).hasClass("ver-mas-link")&&$(o.target).popover("show")}))):($("body").off("mousedown"),$("body").on("mousedown",(function(o){$(".popover").length?$('a[aria-describedby^="popover"]').popover("toggle"):$(o.target).hasClass("ver-mas-link")&&$(o.target).popover("show")})))}));var crearMapaLocalidad=function({latitud:o,longitud:t}){var e=new google.maps.LatLng(parseFloat(o),parseFloat(t));mapa.panTo(e),mapa.setZoom(12)};let direccionACoordenadas=async o=>new Promise((t=>{(new google.maps.Geocoder).geocode({address:o},((o,e)=>e!==google.maps.GeocoderStatus.OK?t(null):t(o[0].geometry.location)))}));var crearMarkersFin=async function(o){removeMarkers(),markers=[];for(const e of o){const o=await direccionACoordenadas(`${e.direccion}, ${e.codigo_postal.codigo_postal}, ${e.codigo_postal.ciudad}, ES`);var t=new google.maps.Marker({position:o,map:mapa,title:e.nombre,icon:imagenMarker,animation:google.maps.Animation.DROP});markers.push(t),crearMarkerListener(t)}};function crearMarkerListener(o){google.maps.event.addListener(o,"click",(function(){var t=$(".punto-list-item").eq(markers.indexOf(o));storesList.mCustomScrollbar("scrollTo",t,{}),hoverStore(t)}))}function removeMarkers(){for(var o=0;o<markers.length;o++)markers[o].setMap(null)}async function showResultadoBusqueda(o,t,e){storesList=$(".stores-list"),visiblePuntos=[];for(const t of o){const o=await direccionACoordenadas(`${t.direccion}, ${t.codigo_postal.codigo_postal}, ${t.codigo_postal.ciudad}, ES`);visiblePuntos.push({...t,latitud:o?.lat(),longitud:o?.lng()})}$(".horario-punto").remove(),storesList.empty(),$(".sin-paquetes").hide(),storesList.show();for(const t of o){const o=t.dropshipping?.imagen||t.entregas_q_commerce?.imagen||"/img/home/store-no-img.png",e=(t.dropshipping?JSON.parse(t.dropshipping?.qcomm_opening_hours).map((o=>{const t=Object.keys(o)[0],e=["L","M","X","J","V","S","D"].indexOf(t)+1,a=o[t];return[{dia:e,inicio:a[0]?.split("-")[0]||null,fin:a[0]?.split("-")[1]||null},{dia:e,inicio:a[1]?.split("-")[0]||null,fin:a[1]?.split("-")[1]||null}]})).reduce(((o,t)=>[...o,...t]),[]):t.entregas_q_commerce?.horarios)||[],r=e.filter((o=>o.dia===(new Date).getDay()))||[];let i="";0===r.length?i="<strong>No hay horario disponible</strong>":(2!==r.length||r[0].inicio&&r[0].fin||r[1].inicio&&r[1].fin)&&(1!==r.length||r[0].inicio&&r[0].fin)?(r.length>=1&&r[0]&&r[0].inicio&&(i+="<strong> &nbsp"+r[0].inicio+"-"+r[0].fin),r.length>=2&&r[1]&&r[1].inicio&&(i+=" "+r[1].inicio+"-"+r[1].fin),i+="</strong>"):i='<strong class="texto-recogida"> &nbspCerrado</strong>';const n=$(`<div class="col-md-12 col-xs-12 no-pd pd-t-15 pd-b-15 punto-list-item" data-lat="${t.latitud}" data-lng="${t.longitud}">\n            <img class="col-md-4 col-xs-12" src="${o}" width="200" onerror="this.onerror=null;this.src='/img/home/store-no-img.png';">\n            <div class="col-md-8 col-xs-11 no-pd punto-datos">\n                <input type="hidden" class="punto-id" value="${t.id}">\n                <input type="hidden" class="store-id" value="${t.id}">\n                <input type="hidden" class="punto-tipo" value="${t.tipo}">\n                <label class="direccion-label nombre">\n                    <i class="icon-punto texto-envio"></i>\n                    <strong>${t.codigo_postal.ciudad}</strong>\n                </label>\n                <small>(${t.id})</small><br>\n                <i class="icon-ubicacion icono-naranja"></i><label class="direccion-label direccion">${t.direccion}</label><br>\n                <i class="fas fa-map icono-naranja"></i><label class="direccion-label direccion">&nbsp&nbsp ${t.codigo_postal.codigo_postal}, ${t.codigo_postal.ciudad}, ${t.codigo_postal.codigo_pais}</label><br>\n                <i class="far fa-clock"> </i><small class="text-secondary"> &nbsp;HOY</small><small class="horario-hoy">${i}</small>&nbsp&nbsp&nbsp\n                <a id="${t.id}" class="ver-mas-link small text-secondary" data-toggle="popover" data-placement="left">Ver más</a>\n                <br>\n                <button id="seleccionar-store-btn" type="button" class="btn btn-warning business-btn-outline with-icon-left mg-t-20 seleccionar-store-btn">\n                    <i class="material-icons">add_circle_outline</i> Seleccionar punto de recogida\n                </button>\n            </div>\n        </div>`);var a=$('<div class="horario-punto horario-table-'+t.id+' hidden"><table class="table table-condensed table-hover table-horario-popover"><tbody><tr class="1"><td class="day">Lunes</td></tr><tr class="2"><td class="day">Martes</td></tr><tr class="3"><td class="day">Miércoles</td></tr><tr class="4"><td class="day">Jueves</td></tr><tr class="5"><td class="day">Viernes</td></tr><tr class="6"><td class="day">Sábado</td></tr><tr class="7"><td class="day">Domingo</td></tr></tbody></table></div>');if(t.dropshipping||t.entregas_q_commerce)for(let o=1;o<=7;o++){const t=e.filter((t=>t.dia===o)),r=t[0].inicio&&t[0].fin||t[1].inicio&&t[1].fin?`<td class="text-nowrap">${t[0].inicio&&t[0].fin?`${t[0].inicio}-${t[0].fin}`:"Cerrado"} | ${t[1].inicio&&t[1].fin?`${t[1].inicio}-${t[1].fin}`:"Cerrado"}</td>`:'<td class="texto-recogida text-nowrap">Cerrado</td>';a.find("tr."+o).append(r)}storesList.append(n),$("body").append(a)}mobile||customScroll(storesList),storesList.find("img").on("load",(function(){storesList.show()})),setTimeout((function(){storesList.show()}),2e3),mobile?$(".punto-list-item").on("click",(function(){hoverStore($(this))})):$(".punto-list-item").hover((function(){hoverStore($(this))})),$("[data-toggle=popover]").each((function(){$(this).popover("destroy"),$(this).popover({trigger:"manual",placement:mobile?"top":"left",html:!0,content:function(){var o=$(this).attr("id");return $(".horario-table-"+o).html()},container:"body"})})),$(".seleccionar-store-btn").click((function(){seleccionarStore($(this).parent().children(".store-id").val(),$(this).parent().children(".punto-tipo").val())})),hoverStore($(".punto-list-item").first())}function hoverStore(o){var t=$(".punto-list-item").index(o),e=visiblePuntos[t],a=findMarker(e);mobile?($(".store-active")!==o&&(clearStoresSelection(),o.addClass("store-active")),0!==t&&t!==$(".punto-list-item").length-1?storesList.animate({scrollLeft:o.width()*t-(storesList.width()-o.width())/2},{duration:400,queue:!1}):storesList.animate({scrollLeft:o.width()*t},{duration:400,queue:!1})):(clearStoresSelection(),o.addClass("store-active")),a.setIcon(markerActivo);var r=new google.maps.LatLng(parseFloat(e.latitud),parseFloat(e.longitud));mapa.panTo(r)}function buscarLocalidad(o,t,e){var a=new google.maps.Geocoder;a.geocode({address:$(".ciudad-input").val()},(function(r,i){i==google.maps.GeocoderStatus.OK?processBusquedaLocalidadResult(r,o,t,e):i==google.maps.GeocoderStatus.ZERO_RESULTS&&a.geocode({address:$(".ciudad-input").val().split("-")[1].trim()},(function(a,r){processBusquedaLocalidadResult(a,o,t,e)}))}))}function processBusquedaLocalidadResult(o,t,e,a){e=o[0].geometry.location.lat(),a=o[0].geometry.location.lng();var r=null;o[0].address_components.forEach((function(o,t){-1!==o.types.indexOf("country")&&(r=o.short_name)}));var i=t.split("-")[0].trim();t.includes("-")&&(t=t.split("-")[1].trim()),$.ajax({dataType:"json",url:"/configuracion/almacenes-recogida/search?nombre="+t+"&lat="+e+"&long="+a+"&cp="+i+"&pais="+r+"&t=2",success:function(o){o.stores.length>0?(crearMapaLocalidad({latitud:o.query.lat,longitud:o.query.long}),crearMarkersFin(o.stores).then((()=>{showResultadoBusqueda(o.stores).then((()=>{$("#modal-stores-search").modal(),initTouchHandler()}))}))):(new PNotify({title:"Transporter",text:"No se han encontrado almacenes en el código postal indicado. Prueba con otra ciudad o código postal.",addclass:"transporter-alert",icon:"icon-transporter",autoDisplay:!0,hide:!0,delay:5e3,closer:!1}),$("#data").empty(),$('input[name^="tipo_recogida"], input[name^="tipo_entrega"]').val(""))},error:function(){showError()}})}function showError(){$(".alert.alert-danger").length||$(".stores-search-container").prepend(error)}function findMarker(o){return markers.find((t=>t.position.lat()===o.latitud&&t.position.lng()===o.longitud))}function findPunto(o){for(var t=0;t<visiblePuntos.length;t++){var e=visiblePuntos[t];if(fixDecimals(o.position.lat())===fixDecimals(parseFloat(e.latitud))&&fixDecimals(o.position.lng())===fixDecimals(parseFloat(e.longitud)))return e}}function fixDecimals(o){var t=o.toString().split(".");return t[0]+"."+t[1].substr(0,6)}function clearStoresSelection(){$(".store-active").removeClass("store-active");for(var o=0;o<markers.length;o++){markers[o].setIcon(imagenMarker)}}var customScroll=function(o){$(o).mCustomScrollbar({theme:"minimal-dark",live:!1,alwaysShowScrollbar:0,scrollbarPosition:"inside",advanced:{autoUpdateTimeout:1}})};
